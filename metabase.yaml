---
namespace: metabase

db:
  defines: runnable
  inherits: postgresql/db
  metadata:
    private: true
  services:
    postgres:
      container: postgres
      port: 5432
      protocol: tcp
  variables:
    db_username:
      value: <- `${postgres-db-user}`
      type: string
    postgres_password:
      value: <- `${postgres-db-password}`
      type: string
    db_name:
      value: <- `${postgres-db-name}`
      type: string

server:
  defines: runnable
  metadata:
    name: Metabase
    description: Metabase is the easy, open source way for everyone in your company to ask questions and learn from data.
    tags: analytics, sql, dashboard
    website: https://www.metabase.com
    source: https://github.com/metabase/metabase
    publisher: monk.io
    email: hello@monk.io
    icon: https://www.metabase.com/images/logo.svg
  connections:
    postgres:
      runnable: metabase/db
      service: postgres
  containers:
    metabase:
      image: metabase/metabase:latest
      ports:
        - <- `${metabase-port}:3000`
  depends:
    wait-for:
      runnables:
        - metabase/db
      timeout: 60
  variables:
    metabase-port:
      type: string
      value: 3000
    mb-db-type:
      type: string
      env: MB_DB_TYPE
      value: postgres
    mb-db-dbname:
      type: string
      env: MB_DB_DBNAME
      value: <- `${postgres-db-name}`
    mb-db-port:
      type: string
      env: MB_DB_PORT
      value: <- connection-port("postgres")
    mb-db-user:
      type: string
      env: MB_DB_USER
      value: <- `${postgres-db-user}`
    mb-db-pass:
      type: string
      env: MB_DB_PASS
      value: <- `${postgres-db-password}`
    mb-db-host:
      type: string
      env: MB_DB_HOST
      value: <- connection-hostname("postgres")

metabase:
  defines: process-group
  runnable-list:
    - metabase/db
    - metabase/server
  variables:
    postgres-db-user:
      type: string
      value: metabase
    postgres-db-password:
      type: string
      value: DB_PASS
    postgres-db-name:
      type: string
      value: metabase
    metabase-port:
      type: string
      value: 3000
